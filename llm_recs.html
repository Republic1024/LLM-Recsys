<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left: 0.25em solid rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
	--side-bar-bg-color: #fff;
	--control-text-color: #777;
	--font-sans-serif: "PingFang SC" !important;
	--font-monospace: "Cascadia Code" !important;
}

body {
	font-family: var(--font-sans-serif);
	color: #34495e;
	-webkit-font-smoothing: antialiased;
	line-height: 1.6rem;
	letter-spacing: 0;
	margin: 0;
	overflow-x: hidden;
}

#write a {
	position: relative;
	text-decoration: none;
	display: inline-block;
	color: #2196f3;
	padding: 0 2px;
}

#write a::before {
	content: "";
	position: absolute;
	bottom: 0;
	left: 50%;
	width: 0;
	height: 1px;
	background-color: #2196f3;
	transition: width 0.3s ease, transform 0.3s ease;
	transform: translateX(-50%);
}

#write a:hover {
	color: #2189db;
}

#write a:hover::before {
	width: 100%;
	background-color: #2189db;
}

#write {
	max-width: 1200px;
	margin: 0 auto;
	padding: 20px 50px 100px;
}

#write p {
	line-height: 1.6rem;
	word-spacing: 0.05rem;
	font-family: 'Cascadia Code','PingFang SC';
}

#write ol li {
	padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
	margin-top: 30px;
}

body > *:first-child {
	margin-top: 0 !important;
}

body > *:last-child {
	margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
	position: relative;
	margin-top: 1rem;
	margin-bottom: 1rem;
	font-weight: bold;
	line-height: 1.4;
	cursor: text;
	color: #32325d;
	font-family: 'Cascadia Code',"PingFang SC";
	transition: all 0.2s ease-out;
}

#write h1:before,
#write h2:before,
#write h3:before,
#write h4:before,
#write h5:before,
#write h6:before {
	content: "";
	display: inline-block;
	background: #2196f3;
	opacity: 1;
	pointer-events: none;
	border-radius: 15px;
	width: 6px;
	vertical-align: middle;
	margin-right: 15px;
	height: 25px;
	transform: translateY(-1px);
}

#write h1:hover,
#write h2:hover,
#write h3:hover,
#write h4:hover,
#write h5:hover,
#write h6:hover {
	transform: translateX(10px);
	transition: all 0.2s ease-out;
}

#write h1:hover a.anchor,
#write h2:hover a.anchor,
#write h3:hover a.anchor,
#write h4:hover a.anchor,
#write h5:hover a.anchor,
#write h6:hover a.anchor {
	text-decoration: none;
}

h1 tt,
h1 code {
	font-size: inherit !important;
}

h2 tt,
h2 code {
	font-size: inherit !important;
}

h3 tt,
h3 code {
	font-size: inherit !important;
}

h4 tt,
h4 code {
	font-size: inherit !important;
}

h5 tt,
h5 code {
	font-size: inherit !important;
}

h6 tt,
h6 code {
	font-size: inherit !important;
}

h2 a,
h3 a {
	color: #34495e;
}

h1 {
	padding-bottom: 0.4rem;
	font-size: 2.2rem;
	line-height: 1.3;
}

h2 {
	font-size: 1.75rem;
	line-height: 1.225;
	margin: 35px 0 15px;
}

h3 {
	font-size: 1.4rem;
	line-height: 1.43;
	margin: 20px 0 7px;
}

h4 {
	font-size: 1.2rem;
}

h5 {
	font-size: 1rem;
}

h6 {
	font-size: 1rem;
	color: #777;
}

p,
blockquote,
ul,
ol,
dl,
table {
	margin: 0.8em 0;
}

li > ol,
li > ul {
	margin: 0 0;
}

hr {
	padding: 0;
	margin: 32px 0;
	border-top: 0.5rem dotted #0590ff57;
	overflow: hidden;
	box-sizing: content-box;
}

body > h2:first-child {
	margin-top: 0;
	padding-top: 0;
}

body > h1:first-child {
	margin-top: 0;
	padding-top: 0;
}

body > h1:first-child + h2 {
	margin-top: 0;
	padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
	margin-top: 0;
	padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
	margin-top: 0;
	padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
	margin-top: 0;
}

li p.first {
	display: inline-block;
}

ul,
ol {
	padding-left: 30px;
}

ul:first-child,
ol:first-child {
	margin-top: 0;
}

ul:last-child,
ol:last-child {
	margin-bottom: 0;
}

blockquote {
	padding: 0.8em 1.4rem;
	margin: 1em 0;
	font-weight: 400;
	border-left: 4px solid #2196f3;
	background-color: #2196f321;
	border-radius: 0px 8px 8px 0px;
	box-shadow: rgb(149 149 149 / 13%) 0px 5px 10px;
}

table {
	padding: 0;
	word-break: initial;
	/* border-radius: 4px; */
}

table tr {
	border-top: 1px solid #2196f31f;
	margin: 0;
	padding: 0;
}

table tr:nth-child(2n),
thead {
	background-color: #fafafa;
}

table tr th {
	font-weight: bold;
	border: 1px solid #9b9b9b3b;
	border-bottom: 0;
	text-align: left;
	margin: 0;
	padding: 6px 13px;
}

table tr td {
	border: 1px solid #9b9b9b3b;
	text-align: left;
	margin: 0;
	padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
	margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
	margin-bottom: 0;
}

#write strong {
	padding: 0 1px;
}

#write em {
	padding: 0 5px 0 2px;
}

#write table thead th {
	background-color: #f2f2f2;
}

#write .CodeMirror-gutters {
	border-right: none;
}

#write .md-fences {
	border: 1px solid #dfdfdfde;
	-webkit-font-smoothing: initial;
	margin: 0.8rem 0 !important;
	padding: 0.8rem 0 !important;
	line-height: 1.43rem;
	background-color: #f8f8f8 !important;
	border-radius: 2px;
	font-family: var(--font-monospace);
	font-size: 0.85rem;
	word-wrap: normal;
	border-radius: 8px;
	font-family: 'Cascadia Code',"PingFang SC";
	box-shadow: rgb(149 149 149 / 13%) 0px 5px 10px;
}

#write .CodeMirror-wrap .CodeMirror-code pre {
	padding-left: 12px;
}

#write code,
tt {
	padding: 2px 6px;
	border-radius: 2px;
	font-family: var(--font-monospace);
	font-size: 0.92rem;
	color: #e96900;
	background-color: #f8f8f8;
	font-family: 'Cascadia Code', "PingFang SC";
	border: 1px solid #e9690017;
	border-radius: 4px;
	padding: 2px 4 px;
}

tt {
	margin: 0 2px;
}

figure {
	border-radius: 8px;
	box-shadow: rgb(149 149 149 / 13%) 0px 5px 10px;
}

#write .md-footnote {
	background-color: #f8f8f8;
	color: #e96900;
}

#write mark {
	background-color: #fffd38;
	border-radius: 4px;
	padding: 2px 4px;
	margin: 0 2px;
	color: #222;
	font-weight: 500;
}

#write del {
	padding: 1px 2px;
}

.md-task-list-item > input {
	margin-left: -1.3em;
}

@media print {
	html {
		font-size: 13px;
	}

	table,
	pre {
		page-break-inside: avoid;
	}

	pre {
		word-wrap: break-word;
	}
}

.md-fences {
	background-color: #f8f8f8;
}

.md-diagram-panel {
	position: static !important;
}

#write pre.md-meta-block {
	padding: 1rem;
	font-size: 85%;
	line-height: 1.45;
	background-color: #f7f7f7;
	border: 0;
	border-radius: 3px;
	color: #777777;
	margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
	bottom: 0.375rem;
}

h3.md-focus:before,
h4.md-focus:before,
h5.md-focus:before,
h6.md-focus:before {
	border: 0px;
	position: unset;
	padding: 0px;
	font-size: unset;
	line-height: unset;
	float: unset;
}

.md-image > .md-meta {
	border-radius: 3px;
	font-family: var(--font-monospace);
	padding: 2px 0 0 4px;
	font-size: 0.9em;
	color: inherit;
}

.md-tag {
	color: inherit;
}

.md-toc {
	margin-top: 20px;
	padding-bottom: 20px;
}

.sidebar-tabs {
	border-bottom: none;
}

#typora-quick-open {
	border: 1px solid #ddd;
	background-color: #f8f8f8;
}

#typora-quick-open-item {
	background-color: #fafafa;
	border-color: #fefefe #e5e5e5 #e5e5e5 #eee;
	border-style: solid;
	border-width: 1px;
}

#md-notification:before {
	top: 10px;
}

/** focus mode */

.on-focus-mode blockquote {
	border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
	font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
	visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
	background-color: var(--side-bar-bg-color);
}

.md-lang {
	color: #b4654d;
}

.html-for-mac .context-menu {
	--item-hover-bg-color: #e6f0fe;
}

.pin-outline #outline-content .outline-active strong,
.pin-outline .outline-active {
	color: #2196f3;
}

.code-tooltip {
	border-radius: 4px;
	border: 1px solid #ededed;
	background-color: #f8f8f8;
}

.cm-s-inner .cm-comment,
.cm-s-inner.cm-comment {
	color: #57a64a;
	font-style: italic;
	/* font-family: 'PingFang'; */
}

h1.md-end-block.md-heading:after,
h2.md-end-block.md-heading:after,
h3.md-end-block.md-heading:after,
h4.md-end-block.md-heading:after,
h5.md-end-block.md-heading:after,
h6.md-end-block.md-heading:after {
	color: #bfbfbf !important;
	border: 1px solid;
	border-radius: 4px;
	position: absolute;
	left: -2.5rem;
	float: left;
	font-size: 14px;
	padding-left: 4px;
	padding-right: 5px;
	vertical-align: bottom;
	font-weight: 400;
	line-height: normal;
	opacity: 0;
}

h1.md-end-block.md-heading:hover:after,
h2.md-end-block.md-heading:hover:after,
h3.md-end-block.md-heading:hover:after,
h4.md-end-block.md-heading:hover:after,
h5.md-end-block.md-heading:hover:after,
h6.md-end-block.md-heading:hover:after {
	opacity: 1;
}

h1.md-end-block.md-heading:hover:after {
	content: "h1";
	top: 1.1rem;
}

h2.md-end-block.md-heading:hover:after {
	content: "h2";
	top: 0.63rem;
}

h3.md-end-block.md-heading:hover:after {
	content: "h3";
	top: 0.55rem;
}

h4.md-end-block.md-heading:hover:after {
	content: "h4";
	top: 0.3rem;
}

h5.md-end-block.md-heading:hover:after {
	content: "h5";
	top: 0.18rem;
}

h6.md-end-block.md-heading:hover:after {
	content: "h6";
	top: 0.16rem;
}

.outline-label {
    font-family: 'Cascadia Code',"PingFang SC";
}


</style><title>llm_recs_2</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='项目介绍基于大语言模型llm的个性化推荐排序'><span>项目介绍：基于大语言模型（LLM）的个性化推荐排序</span></h1><h2 id='项目目标'><span>项目目标</span></h2><p><span>本项目旨在通过大语言模型（LLM）对电影推荐结果进行 </span><strong><span>重排序（reranking）</span></strong><span>，基于用户的历史喜好和评分，优化电影推荐的准确性和排序效果。</span></p><h2 id='项目背景'><span>项目背景</span></h2><ul><li><p><span>传统的电影推荐系统通常依赖于基于内容的过滤、协同过滤或混合方法来生成初步的推荐列表。然而，这些方法往往忽略了用户的具体偏好以及电影之间更细粒度的关联。</span></p></li><li><p><span>使用GPT Based方法可以通过自然语言处理用户历史的喜好数据，为推荐系统提供更个性化、符合用户心理模型的排序结果。</span></p></li></ul><h2 id='方法概述'><span>方法概述</span></h2><ol start='' ><li><p><strong><span>数据准备</span></strong><span>：</span></p><ul><li><p><span>从用户历史评分数据中提取出 </span><strong><span>喜欢</span></strong><span> 和 </span><strong><span>不喜欢</span></strong><span> 的电影，构建每个用户的喜好画像。用户的喜好不仅仅通过评分体现，还可以通过评论和标签等其他方式进一步丰富。</span></p></li></ul></li><li><p><strong><span>候选电影召回</span></strong><span>：</span></p><ul><li><p><span>使用传统的推荐算法（如 </span><strong><span>协同过滤</span></strong><span> 或 </span><strong><span>基于内容的推荐</span></strong><span>）生成一个初步的候选电影列表。传统方法依赖用户的历史评分数据，可能会根据相似用户的行为或相似电影的特征进行推荐，但未能考虑用户的动态兴趣和电影之间的深层次关联。</span></p></li></ul></li><li><p><strong><span>大模型输入</span></strong><span>：</span></p><ul><li><p><span>将用户的历史喜好信息与候选电影一同输入 </span><strong><span>大语言模型（如 GPT）</span></strong><span>。该模型能够通过处理用户喜好与电影内容，推断每部电影的 </span><strong><span>喜欢度</span></strong><span> 和推荐理由。</span></p></li><li><p><span>GPT 可以从自然语言中理解用户的潜在偏好，比如通过对用户历史评分的上下文进行分析，判断用户对某种类型电影的潜在兴趣。</span></p></li></ul></li><li><p><strong><span>重新排序</span></strong><span>：</span></p><ul><li><p><span>基于大模型输出的 </span><strong><span>喜欢</span></strong><span> 和 </span><strong><span>不喜欢</span></strong><span> 结果，对候选电影进行重新排序。模型通过分析电影与用户偏好的契合度，以及每个推荐理由的相关性，生成更符合用户当前兴趣的推荐结果。</span></p></li><li><p><span>与传统协同过滤相比，这一过程考虑了更多维度的特征，如情感分析、电影背景、用户的情感偏好等，使推荐更加精准。</span></p></li></ul></li><li><p><strong><span>评估</span></strong><span>：</span></p><ul><li><p><span>使用 </span><strong><span>准确率（Precision）</span></strong><span>、</span><strong><span>召回率（Recall）</span></strong><span> 和 </span><strong><span>NDCG</span></strong><span>（Normalized Discounted Cumulative Gain）等指标评估排序效果，展示模型优化的效果。通过比较模型在不同阶段的表现，能够直观反映大语言模型如何提升推荐系统的精度和覆盖率。</span></p></li></ul></li></ol><h2 id='数据集'><span>数据集</span></h2><ul><li><p><strong><span>用户评分数据</span></strong><span>：包含用户对电影的评分记录，每条记录包括用户ID、电影ID、评分和喜好（喜欢/不喜欢）。</span></p></li><li><p><strong><span>电影数据</span></strong><span>：包含电影的基本信息（如电影名称、发行年份、类型等）。</span></p></li></ul><p>&nbsp;</p><h2 id='数据集介绍'><span>数据集介绍</span></h2><p><span>该数据集是 </span><strong><span>MovieLens 100k</span></strong><span> 数据集，包含用户对电影的评分信息。数据集广泛用于推荐系统研究，包含以下几部分数据：</span></p><ol start='' ><li><p><strong><span>用户数据 (</span><code>u.user</code><span>)</span></strong><span>：</span></p><ul><li><p><strong><span>用户ID (</span><code>user id</code><span>)</span></strong><span>：唯一标识每个用户。</span></p></li><li><p><strong><span>年龄 (</span><code>age</code><span>)</span></strong><span>：用户的年龄（通过年龄段分类）。</span></p></li><li><p><strong><span>性别 (</span><code>gender</code><span>)</span></strong><span>：用户的性别（男性或女性）。</span></p></li><li><p><strong><span>职业 (</span><code>occupation</code><span>)</span></strong><span>：用户的职业类型。</span></p></li><li><p><strong><span>邮政编码 (</span><code>zip code</code><span>)</span></strong><span>：用户的邮政编码。</span></p></li></ul></li><li><p><strong><span>电影数据 (</span><code>u.item</code><span>)</span></strong><span>：</span></p><ul><li><p><strong><span>电影ID (</span><code>item id</code><span>)</span></strong><span>：唯一标识每部电影。</span></p></li><li><p><strong><span>电影标题 (</span><code>title</code><span>)</span></strong><span>：电影的名称。</span></p></li><li><p><strong><span>上映日期 (</span><code>release date</code><span>)</span></strong><span>：电影的首次上映日期。</span></p></li><li><p><strong><span>视频发布日期 (</span><code>video release date</code><span>)</span></strong><span>：电影的发行视频日期（如果有）。</span></p></li><li><p><strong><span>IMDb链接 (</span><code>IMDb URL</code><span>)</span></strong><span>：电影在IMDb上的链接。</span></p></li><li><p><strong><span>电影类型</span></strong><span>：该数据集包含了电影的多个类别标签，例如：动作、冒险、动画、儿童、喜剧、犯罪等。</span></p></li></ul></li><li><p><strong><span>评分数据 (</span><code>u.data</code><span>)</span></strong><span>：</span></p><ul><li><p><strong><span>用户ID (</span><code>user id</code><span>)</span></strong><span>：唯一标识每个用户。</span></p></li><li><p><strong><span>电影ID (</span><code>item id</code><span>)</span></strong><span>：唯一标识每部电影。</span></p></li><li><p><strong><span>评分 (</span><code>rating</code><span>)</span></strong><span>：用户对电影的评分，评分范围从 1 到 5，越高表示越喜欢。</span></p></li><li><p><strong><span>时间戳 (</span><code>timestamp</code><span>)</span></strong><span>：评分产生的时间，记录为 Unix 时间戳（自1970年1月1日起的秒数），经过转换后表示为日期时间。</span></p></li></ul></li><li><p><strong><span>评分标记 (</span><code>like</code><span>)</span></strong><span>：</span></p><ul><li><p><span>通过对评分数据进行处理，将用户评分大于 3 的电影标记为“喜欢”（</span><code>like = True</code><span>），否则标记为“不喜欢”（</span><code>like = False</code><span>）。</span></p></li></ul></li></ol><h3 id='数据集的目标'><strong><span>数据集的目标</span></strong><span>：</span></h3><ul><li><p><span>本数据集用于电影推荐系统的开发与评估，通常目的是根据用户的历史评分，预测其可能喜欢的电影。</span></p></li><li><p><span>数据集包含了用户与电影的交互历史，通过分析用户的评分行为，可以为用户推荐他们未观看过的电影。</span></p></li></ul><h3 id='数据集大小'><strong><span>数据集大小</span></strong><span>：</span></h3><ul><li><p><strong><span>用户数</span></strong><span>：包含了 </span><strong><span>100,000</span></strong><span> 个电影评分记录，这些评分来自于 </span><strong><span>943</span></strong><span> 个用户。</span></p></li><li><p><strong><span>电影数</span></strong><span>：数据集包含 </span><strong><span>1682</span></strong><span> 部电影。</span></p></li><li><p><strong><span>评分范围</span></strong><span>：每个评分都在 1 到 5 之间，代表了用户对电影的喜好程度。</span></p></li></ul><h2 id='名词介绍'><span>名词介绍</span></h2><h3 id='1-准确率-precision'><strong><span>1. 准确率 (Precision)</span></strong></h3><p><strong><span>准确率</span></strong><span> 衡量的是推荐列表中的电影中有多少是用户实际喜欢的。它反映了推荐系统的 </span><strong><span>准确性</span></strong><span>，即推荐给用户的电影中有多少电影是用户喜欢的。</span></p><h4 id='公式'><strong><span>公式</span></strong><span>：</span></h4><p><span>[</span>
<span>\text{Precision} = \frac{\text{推荐电影中用户喜欢的电影数}}{\text{推荐的电影总数}}</span>
<span>]</span></p><h4 id='举个例子'><strong><span>举个例子</span></strong><span>：</span></h4><p><span>假设推荐系统为用户推荐了 5 部电影，推荐结果如下：</span></p><ul><li><p><span>推荐电影：</span><code>[Movie A, Movie B, Movie C, Movie D, Movie E]</code></p></li><li><p><span>用户喜欢的电影：</span><code>[Movie A, Movie D]</code></p></li></ul><p><span>那么：</span></p><ul><li><p><span>推荐电影中用户喜欢的电影有 2 部（</span><code>Movie A</code><span>, </span><code>Movie D</code><span>）。</span></p></li><li><p><span>总共推荐了 5 部电影。</span></p></li></ul><p><span>因此，准确率为：</span>
<span>[</span>
<span>\text{Precision} = \frac{2}{5} = 0.4</span>
<span>]</span>
<span>即推荐的电影中有 </span><strong><span>40%</span></strong><span> 是用户实际喜欢的。</span></p><hr /><h3 id='2-召回率-recall'><strong><span>2. 召回率 (Recall)</span></strong></h3><p><strong><span>召回率</span></strong><span> 衡量的是用户所有喜欢的电影中，有多少出现在推荐列表中。它反映了推荐系统的 </span><strong><span>全面性</span></strong><span>，即推荐系统是否能够覆盖用户真正喜欢的电影。</span></p><h4 id='公式-2'><strong><span>公式</span></strong><span>：</span></h4><p><span>[</span>
<span>\text{Recall} = \frac{\text{推荐的用户喜欢的电影数}}{\text{用户实际喜欢的电影总数}}</span>
<span>]</span></p><h4 id='举个例子-2'><strong><span>举个例子</span></strong><span>：</span></h4><p><span>假设用户实际上喜欢 4 部电影，推荐系统推荐了 5 部电影，推荐结果如下：</span></p><ul><li><p><span>推荐电影：</span><code>[Movie A, Movie B, Movie C, Movie D, Movie E]</code></p></li><li><p><span>用户喜欢的电影：</span><code>[Movie A, Movie D, Movie F, Movie G]</code></p></li></ul><p><span>那么：</span></p><ul><li><p><span>推荐的用户喜欢的电影有 2 部（</span><code>Movie A</code><span>, </span><code>Movie D</code><span>）。</span></p></li><li><p><span>用户实际喜欢的电影总数为 4 部（</span><code>Movie A</code><span>, </span><code>Movie D</code><span>, </span><code>Movie F</code><span>, </span><code>Movie G</code><span>）。</span></p></li></ul><p><span>因此，召回率为：</span>
<span>[</span>
<span>\text{Recall} = \frac{2}{4} = 0.5</span>
<span>]</span>
<span>即推荐列表中的 </span><strong><span>50%</span></strong><span> 是用户实际喜欢的电影。</span></p><hr /><h3 id='总结'><strong><span>总结：</span></strong></h3><ul><li><p><strong><span>准确率 (Precision)</span></strong><span> 衡量的是推荐的电影中有多少是用户实际喜欢的。推荐系统的准确率越高，意味着推荐的电影越符合用户的兴趣。</span></p></li><li><p><strong><span>召回率 (Recall)</span></strong><span> 衡量的是用户喜欢的电影中有多少出现在推荐列表中。召回率越高，意味着推荐系统能够覆盖更多用户喜欢的电影。</span></p></li></ul><p><span>在推荐系统的优化过程中，我们通常需要平衡这两个指标。提高准确率可能会降低召回率，因为系统推荐的电影会更加精确，但可能会错过一些用户喜欢的电影。而提高召回率可能会增加不相关或不喜欢的电影，降低准确率。因此，通常需要找到一个平衡点，确保推荐既有较高的准确性，也能覆盖更多用户喜欢的电影。</span></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># !unzip sample_data/ml-100k.zip -d sample_data</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">seaborn</span> <span class="cm-keyword">as</span> <span class="cm-variable">sns</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">numpy</span> <span class="cm-keyword">as</span> <span class="cm-variable">np</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">matplotlib</span>.<span class="cm-property">pyplot</span> <span class="cm-keyword">as</span> <span class="cm-variable">plt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">warnings</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">pylab</span> <span class="cm-keyword">import</span> <span class="cm-variable">mpl</span>, <span class="cm-variable">plt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># best font and style settings for notebook </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">warnings</span>.<span class="cm-property">filterwarnings</span>(<span class="cm-string">'ignore'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sns</span>.<span class="cm-property">set_style</span>(<span class="cm-string">"white"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mpl</span>.<span class="cm-property">rcParams</span>[<span class="cm-string">'font.family'</span>] <span class="cm-operator">=</span> <span class="cm-string">'MiSans'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 200px;"></div><div class="CodeMirror-gutters" style="display: none; height: 200px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pandas</span> <span class="cm-keyword">as</span> <span class="cm-variable">pd</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">numpy</span> <span class="cm-keyword">as</span> <span class="cm-variable">np</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">time</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">datetime</span> <span class="cm-keyword">import</span> <span class="cm-variable">datetime</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">dir</span> <span class="cm-operator">=</span> <span class="cm-string">'sample_data/ml-100k'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">col_names</span> <span class="cm-operator">=</span> [<span class="cm-string">'user id'</span>, <span class="cm-string">'item id'</span>, <span class="cm-string">'rating'</span>, <span class="cm-string">'timestamp'</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">read_csv</span>(<span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">join</span>(<span class="cm-builtin">dir</span>, <span class="cm-string">'u.data'</span>), <span class="cm-variable">delimiter</span><span class="cm-operator">=</span><span class="cm-string">'\t'</span>, <span class="cm-variable">names</span><span class="cm-operator">=</span><span class="cm-variable">col_names</span>, <span class="cm-variable">header</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span>[<span class="cm-string">'timestamp'</span>] <span class="cm-operator">=</span> <span class="cm-variable">data</span>[<span class="cm-string">'timestamp'</span>].<span class="cm-property">apply</span>(<span class="cm-keyword">lambda</span> <span class="cm-variable">x</span>: <span class="cm-variable">datetime</span>.<span class="cm-property">fromtimestamp</span>(<span class="cm-variable">x</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">join</span>(<span class="cm-builtin">dir</span>, <span class="cm-string">'u.item'</span>), <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">"ISO-8859-1"</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">movie</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">read_csv</span>(<span class="cm-variable">f</span>, <span class="cm-variable">delimiter</span><span class="cm-operator">=</span><span class="cm-string">'|'</span>, <span class="cm-variable">header</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">movie</span>.<span class="cm-property">columns</span> <span class="cm-operator">=</span> [<span class="cm-string">'item id'</span>, <span class="cm-string">'title'</span>, <span class="cm-string">'release date'</span>, <span class="cm-string">'video release date'</span>, <span class="cm-string">'IMDb URL'</span>, <span class="cm-string">'unknown'</span>, <span class="cm-string">'Action'</span>, <span class="cm-string">'Adventure'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'Animation'</span>, <span class="cm-string">'Children\'s'</span>, <span class="cm-string">'Comedy'</span>, <span class="cm-string">'Crime'</span>, <span class="cm-string">'Documentary'</span>, <span class="cm-string">'Drama'</span>, <span class="cm-string">'Fantasy'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'Film-Noir'</span>, <span class="cm-string">'Horror'</span>, <span class="cm-string">'Musical'</span>, <span class="cm-string">'Mystery'</span>, <span class="cm-string">'Romance'</span>, <span class="cm-string">'Sci-Fi'</span>, <span class="cm-string">'Thriller'</span>, <span class="cm-string">'War'</span>, <span class="cm-string">'Western'</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">join</span>(<span class="cm-builtin">dir</span>, <span class="cm-string">'u.user'</span>), <span class="cm-variable">encoding</span><span class="cm-operator">=</span><span class="cm-string">"ISO-8859-1"</span>) <span class="cm-keyword">as</span> <span class="cm-variable">f</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">user</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">read_csv</span>(<span class="cm-variable">f</span>, <span class="cm-variable">delimiter</span><span class="cm-operator">=</span><span class="cm-string">'|'</span>, <span class="cm-variable">header</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">user</span>.<span class="cm-property">columns</span> <span class="cm-operator">=</span> [<span class="cm-string">'user id'</span>, <span class="cm-string">'age'</span>, <span class="cm-string">'gender'</span>, <span class="cm-string">'occupation'</span>, <span class="cm-string">'zip code'</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span>.<span class="cm-property">merge</span>(<span class="cm-variable">movie</span>[[<span class="cm-string">'item id'</span>, <span class="cm-string">'title'</span>]], <span class="cm-variable">on</span><span class="cm-operator">=</span><span class="cm-string">'item id'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings</span>[<span class="cm-string">'like'</span>] <span class="cm-operator">=</span> <span class="cm-variable">ratings</span>[<span class="cm-string">'rating'</span>] <span class="cm-operator">&gt;</span> <span class="cm-number">3</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 620px;"></div><div class="CodeMirror-gutters" style="display: none; height: 620px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings</span>.<span class="cm-property">sort_values</span>(<span class="cm-variable">by</span><span class="cm-operator">=</span>[<span class="cm-string">'user id'</span>], <span class="cm-variable">ascending</span><span class="cm-operator">=</span>[<span class="cm-keyword">True</span>]).<span class="cm-property">head</span>(<span class="cm-number">10</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><p>&nbsp;</p><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }<pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.dataframe tbody tr th {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  vertical-align: top;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.dataframe thead th {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  text-align: right;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 140px;"></div><div class="CodeMirror-gutters" style="display: none; height: 140px;"></div></div></div></pre></style><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user id</th>
      <th>item id</th>
      <th>rating</th>
      <th>timestamp</th>
      <th>title</th>
      <th>like</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>66567</th>
      <td>1</td>
      <td>55</td>
      <td>5</td>
      <td>1997-09-24 11:44:48</td>
      <td>Professional, The (1994)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>62820</th>
      <td>1</td>
      <td>203</td>
      <td>4</td>
      <td>1997-11-03 15:30:31</td>
      <td>Unforgiven (1992)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>10207</th>
      <td>1</td>
      <td>183</td>
      <td>5</td>
      <td>1997-09-24 11:37:42</td>
      <td>Alien (1979)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9971</th>
      <td>1</td>
      <td>150</td>
      <td>5</td>
      <td>1997-10-15 13:09:56</td>
      <td>Swingers (1996)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>22496</th>
      <td>1</td>
      <td>68</td>
      <td>4</td>
      <td>1997-09-24 11:44:48</td>
      <td>Crow, The (1994)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9811</th>
      <td>1</td>
      <td>201</td>
      <td>3</td>
      <td>1997-11-03 15:42:40</td>
      <td>Evil Dead II (1987)</td>
      <td>False</td>
    </tr>
    <tr>
      <th>9722</th>
      <td>1</td>
      <td>157</td>
      <td>4</td>
      <td>1997-10-15 13:21:58</td>
      <td>Platoon (1986)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9692</th>
      <td>1</td>
      <td>184</td>
      <td>4</td>
      <td>1997-09-24 11:49:16</td>
      <td>Army of Darkness (1993)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9566</th>
      <td>1</td>
      <td>210</td>
      <td>4</td>
      <td>1997-11-03 15:41:49</td>
      <td>Indiana Jones and the Last Crusade (1989)</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9382</th>
      <td>1</td>
      <td>163</td>
      <td>4</td>
      <td>1997-09-24 11:40:42</td>
      <td>Return of the Pink Panther, The (1974)</td>
      <td>True</td>
    </tr>
  </tbody>
</table><p></div></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">train_ratio</span> <span class="cm-operator">=</span> <span class="cm-number">0.9</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">train_size</span> <span class="cm-operator">=</span> <span class="cm-builtin">int</span>(<span class="cm-builtin">len</span>(<span class="cm-variable">ratings</span>) <span class="cm-operator">*</span> <span class="cm-variable">train_ratio</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings_train</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings</span>.<span class="cm-property">sample</span>(<span class="cm-variable">train_size</span>, <span class="cm-variable">random_state</span><span class="cm-operator">=</span><span class="cm-number">42</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings_test</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings</span>[<span class="cm-operator">~</span><span class="cm-variable">ratings</span>.<span class="cm-property">index</span>.<span class="cm-property">isin</span>(<span class="cm-variable">ratings_train</span>.<span class="cm-property">index</span>)]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 80px;"></div><div class="CodeMirror-gutters" style="display: none; height: 80px;"></div></div></div></pre><h2 id='recall-mf'><span>Recall (MF)</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># pip install implicit</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">scipy</span>.<span class="cm-property">sparse</span> <span class="cm-keyword">import</span> <span class="cm-variable">csr_matrix</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">n_users</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[<span class="cm-string">'user id'</span>].<span class="cm-property">max</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">n_item</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[<span class="cm-string">'item id'</span>].<span class="cm-property">max</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings_train_pos</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[<span class="cm-variable">ratings_train</span>[<span class="cm-string">'like'</span>]]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ratings_test_pos</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_test</span>[<span class="cm-variable">ratings_test</span>[<span class="cm-string">'like'</span>]]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">row</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train_pos</span>[<span class="cm-string">'user id'</span>].<span class="cm-property">values</span> <span class="cm-operator">-</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">col</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train_pos</span>[<span class="cm-string">'item id'</span>].<span class="cm-property">values</span> <span class="cm-operator">-</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">np</span>.<span class="cm-property">ones</span>(<span class="cm-builtin">len</span>(<span class="cm-variable">ratings_train_pos</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">user_item_data</span> <span class="cm-operator">=</span> <span class="cm-variable">csr_matrix</span>((<span class="cm-variable">data</span>, (<span class="cm-variable">row</span>, <span class="cm-variable">col</span>)), <span class="cm-variable">shape</span><span class="cm-operator">=</span>(<span class="cm-variable">n_users</span>, <span class="cm-variable">n_item</span>))</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">implicit</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># initialize a model</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">model</span> <span class="cm-operator">=</span> <span class="cm-variable">implicit</span>.<span class="cm-property">als</span>.<span class="cm-property">AlternatingLeastSquares</span>(<span class="cm-variable">factors</span><span class="cm-operator">=</span><span class="cm-number">50</span>, <span class="cm-variable">random_state</span><span class="cm-operator">=</span><span class="cm-number">42</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># train the model on a sparse matrix of user/item/confidence weights</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">model</span>.<span class="cm-property">fit</span>(<span class="cm-variable">user_item_data</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 140px;"></div><div class="CodeMirror-gutters" style="display: none; height: 140px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  0%| &nbsp; &nbsp; &nbsp; &nbsp;  | 0/15 [00:00&lt;?, ?it/s]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><h2 id='传统方法-协同过滤的处理过程'><span>传统方法-协同过滤的处理过程</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 导入用于计算DCG和NDCG的评估函数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">sklearn</span>.<span class="cm-property">metrics</span> <span class="cm-keyword">import</span> <span class="cm-variable">dcg_score</span>, <span class="cm-variable">ndcg_score</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 40px;"></div><div class="CodeMirror-gutters" style="display: none; height: 40px;"></div></div></div></pre><h3 id='1-precisionk计算准确率precisionk'><strong><span>1. </span><code>precision_k</code><span>：计算准确率（Precision）@k</span></strong></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">precision_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">len</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]).<span class="cm-property">intersection</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">actuals</span>))) <span class="cm-operator">/</span> <span class="cm-variable">k</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 40px;"></div><div class="CodeMirror-gutters" style="display: none; height: 40px;"></div></div></div></pre><ul><li><p><strong><span>功能</span></strong><span>：计算推荐结果中前 </span><code>k</code><span> 个电影中，有多少是用户实际喜欢的电影的比例，即准确率（Precision）。</span></p></li><li><p><strong><span>参数</span></strong><span>：</span></p><ul><li><p><code>actuals</code><span>：用户实际喜欢的电影的列表。</span></p></li><li><p><code>recs</code><span>：推荐系统为该用户推荐的电影列表。</span></p></li><li><p><code>k</code><span>：关注的前 </span><code>k</code><span> 个推荐（默认为 5）。</span></p></li></ul></li><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><span>首先，</span><code>recs[0:k]</code><span> 获取推荐的前 </span><code>k</code><span> 个电影，</span><code>set(recs[0:k])</code><span> 将其转换为集合以去重。</span></p></li><li><p><code>actuals</code><span> 是用户实际喜欢的电影列表。</span></p></li><li><p><code>set(recs[0:k]).intersection(set(actuals))</code><span> 找到推荐列表和实际喜欢的电影的交集，即推荐的用户实际喜欢的电影。</span></p></li><li><p><span>准确率是交集的大小除以 </span><code>k</code><span>，表示推荐的电影中有多少比例是用户喜欢的。</span></p></li></ul></li></ul><hr /><h3 id='2-recallk计算召回率recallk'><strong><span>2. </span><code>recall_k</code><span>：计算召回率（Recall）@k</span></strong></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">recall_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">len</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]).<span class="cm-property">intersection</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">actuals</span>))) <span class="cm-operator">/</span> <span class="cm-builtin">len</span>(<span class="cm-variable">actuals</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 40px;"></div><div class="CodeMirror-gutters" style="display: none; height: 40px;"></div></div></div></pre><ul><li><p><strong><span>功能</span></strong><span>：计算推荐结果中，用户实际喜欢的电影有多少被推荐的比例，即召回率（Recall）。</span></p></li><li><p><strong><span>参数</span></strong><span>：</span></p><ul><li><p><code>actuals</code><span>：用户实际喜欢的电影的列表。</span></p></li><li><p><code>recs</code><span>：推荐系统为该用户推荐的电影列表。</span></p></li><li><p><code>k</code><span>：关注的前 </span><code>k</code><span> 个推荐（默认为 5）。</span></p></li></ul></li><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><span>与准确率不同，召回率衡量的是用户喜欢的电影中有多少被推荐系统包含。</span></p></li><li><p><span>通过计算推荐电影列表和实际喜欢电影的交集大小，并除以用户实际喜欢的电影数，得到召回率。</span></p></li></ul></li></ul><hr /><h3 id='3-dcgk计算dcgdiscounted-cumulative-gaink'><strong><span>3. </span><code>dcg_k</code><span>：计算DCG（Discounted Cumulative Gain）@k</span></strong></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">dcg_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">relevance</span> <span class="cm-operator">=</span> <span class="cm-variable">np</span>.<span class="cm-property">array</span>([[<span class="cm-builtin">float</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">actuals</span>) <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">score</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span> <span class="cm-operator">-</span> <span class="cm-variable">np</span>.<span class="cm-property">arange</span>(<span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">dcg_score</span>(<span class="cm-variable">relevance</span>, <span class="cm-variable">score</span>.<span class="cm-property">reshape</span>(<span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>), <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-variable">k</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 80px;"></div><div class="CodeMirror-gutters" style="display: none; height: 80px;"></div></div></div></pre><ul><li><p><strong><span>功能</span></strong><span>：计算 </span><strong><span>Discounted Cumulative Gain (DCG)</span></strong><span>，衡量推荐列表中电影的排名是否符合用户的偏好。DCG 考虑了推荐结果的排名顺序，排名靠前的电影对用户的影响更大。</span></p></li><li><p><strong><span>参数</span></strong><span>：</span></p><ul><li><p><code>actuals</code><span>：用户实际喜欢的电影的列表。</span></p></li><li><p><code>recs</code><span>：推荐系统为该用户推荐的电影列表。</span></p></li><li><p><code>k</code><span>：关注的前 </span><code>k</code><span> 个推荐（默认为 5）。</span></p></li></ul></li><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><strong><span>Relevance</span></strong><span>：根据电影是否在 </span><code>actuals</code><span>（用户喜欢的电影）列表中，将推荐电影的相关性设为 1（喜欢）或 0（不喜欢）。</span></p></li><li><p><strong><span>Score</span></strong><span>：为每个推荐电影分配一个分数，越靠前的电影得分越高，通常是 </span><code>k-1</code><span> 到 </span><code>0</code><span>，表示从推荐列表顶部到底部的递减。</span></p></li><li><p><code>dcg_score</code><span> 函数计算实际推荐的 DCG 值，评分越高的电影排名靠前，DCG 会更高。</span></p></li></ul></li></ul><hr /><h3 id='4-ndcgk计算ndcgnormalized-discounted-cumulative-gaink'><strong><span>4. </span><code>ndcg_k</code><span>：计算NDCG（Normalized Discounted Cumulative Gain）@k</span></strong></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">ndcg_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">relevance</span> <span class="cm-operator">=</span> <span class="cm-variable">np</span>.<span class="cm-property">array</span>([[<span class="cm-builtin">float</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">actuals</span>) <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">score</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span> <span class="cm-operator">-</span> <span class="cm-variable">np</span>.<span class="cm-property">arange</span>(<span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">ndcg_score</span>(<span class="cm-variable">relevance</span>, <span class="cm-variable">score</span>.<span class="cm-property">reshape</span>(<span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>), <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-variable">k</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 80px;"></div><div class="CodeMirror-gutters" style="display: none; height: 80px;"></div></div></div></pre><ul><li><p><strong><span>功能</span></strong><span>：计算 </span><strong><span>Normalized Discounted Cumulative Gain (NDCG)</span></strong><span>，与 DCG 相似，但 NDCG 会进行归一化，确保不同大小的推荐列表之间可以比较。</span></p></li><li><p><strong><span>参数</span></strong><span>：</span></p><ul><li><p><code>actuals</code><span>：用户实际喜欢的电影的列表。</span></p></li><li><p><code>recs</code><span>：推荐系统为该用户推荐的电影列表。</span></p></li><li><p><code>k</code><span>：关注的前 </span><code>k</code><span> 个推荐（默认为 5）。</span></p></li></ul></li><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><strong><span>Relevance</span></strong><span> 和 </span><strong><span>Score</span></strong><span> 的计算方法与 DCG 相同。</span></p></li><li><p><code>ndcg_score</code><span> 会计算归一化后的 DCG，NDCG 值越高说明推荐列表的顺序越符合用户的实际偏好，推荐系统的排序质量越高。</span></p></li></ul></li></ul><hr /><h3 id='5-recallstage生成推荐电影'><strong><span>5. </span><code>recall_stage</code><span>：生成推荐电影</span></strong></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">recall_stage</span>(<span class="cm-variable">model</span>, <span class="cm-variable">user_id</span>, <span class="cm-variable">user_item_data</span>, <span class="cm-variable">ratings_train</span>, <span class="cm-variable">N</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">filter_items</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[<span class="cm-variable">ratings_train</span>[<span class="cm-string">'user id'</span>] <span class="cm-operator">==</span> <span class="cm-variable">user_id</span>][<span class="cm-string">'item id'</span>].<span class="cm-property">values</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">filter_items</span> <span class="cm-operator">=</span> <span class="cm-variable">filter_items</span> <span class="cm-operator">-</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">user_id</span> <span class="cm-operator">=</span> <span class="cm-variable">user_id</span> <span class="cm-operator">-</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recs</span>, <span class="cm-variable">scores</span> <span class="cm-operator">=</span> <span class="cm-variable">model</span>.<span class="cm-property">recommend</span>(<span class="cm-variable">user_id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">user_item_data</span>[<span class="cm-variable">user_id</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">filter_items</span><span class="cm-operator">=</span><span class="cm-variable">filter_items</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">N</span><span class="cm-operator">=</span><span class="cm-variable">N_recall</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recs</span> <span class="cm-operator">=</span> <span class="cm-variable">recs</span>.<span class="cm-property">flatten</span>() <span class="cm-operator">+</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">recs</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><ul><li><p><strong><span>功能</span></strong><span>：生成推荐电影列表。该函数利用推荐模型根据用户历史数据生成推荐，并且排除了用户已经评分的电影。</span></p></li><li><p><strong><span>参数</span></strong><span>：</span></p><ul><li><p><code>model</code><span>：推荐模型（例如基于协同过滤、矩阵分解的模型）。</span></p></li><li><p><code>user_id</code><span>：目标用户的 ID。</span></p></li><li><p><code>user_item_data</code><span>：包含用户-物品交互信息的稀疏矩阵。</span></p></li><li><p><code>ratings_train</code><span>：用户历史评分数据。</span></p></li><li><p><code>N</code><span>：需要推荐的电影数量。</span></p></li></ul></li><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><span>根据用户的历史评分，生成推荐列表 </span><code>recs</code><span>，并排除用户已经评分的电影。</span></p></li><li><p><span>推荐列表返回的是用户最可能喜欢的电影，推荐数量为 </span><code>N_recall</code><span>。</span></p></li></ul></li></ul><hr /><h3 id='6-evaluate评估推荐效果'><strong><span>6. </span><code>evaluate</code><span>：评估推荐效果</span></strong></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">evaluate</span>(<span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_test_pos</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">actuals</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_test_pos</span>[<span class="cm-variable">ratings_test_pos</span>[<span class="cm-string">'user id'</span>] <span class="cm-operator">==</span> <span class="cm-variable">user_id</span>][<span class="cm-string">'item id'</span>].<span class="cm-property">values</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">precision_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>), <span class="cm-variable">recall_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>), <span class="cm-variable">dcg_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 80px;"></div><div class="CodeMirror-gutters" style="display: none; height: 80px;"></div></div></div></pre><ul><li><p><strong><span>功能</span></strong><span>：评估推荐系统的效果，计算 </span><strong><span>准确率</span></strong><span>、</span><strong><span>召回率</span></strong><span> 和 </span><strong><span>NDCG</span></strong><span>。</span></p></li><li><p><strong><span>参数</span></strong><span>：</span></p><ul><li><p><code>user_id</code><span>：目标用户的 ID。</span></p></li><li><p><code>ratings_test_pos</code><span>：测试集，包含用户喜欢的电影数据。</span></p></li><li><p><code>recs</code><span>：推荐系统为该用户推荐的电影列表。</span></p></li><li><p><code>k</code><span>：评估的前 </span><code>k</code><span> 个推荐（默认为 5）。</span></p></li></ul></li><li><p><strong><span>解释</span></strong><span>：</span></p><ul><li><p><span>该函数计算并返回用户的 </span><strong><span>Precision@k</span></strong><span>、</span><strong><span>Recall@k</span></strong><span> 和 </span><strong><span>NDCG@k</span></strong><span>，用于衡量推荐系统的质量。</span></p></li></ul></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">sklearn</span>.<span class="cm-property">metrics</span> <span class="cm-keyword">import</span> <span class="cm-variable">dcg_score</span>, <span class="cm-variable">ndcg_score</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">precision_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">len</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]).<span class="cm-property">intersection</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">actuals</span>))) <span class="cm-operator">/</span> <span class="cm-variable">k</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">recall_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">len</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]).<span class="cm-property">intersection</span>(<span class="cm-builtin">set</span>(<span class="cm-variable">actuals</span>))) <span class="cm-operator">/</span> <span class="cm-builtin">len</span>(<span class="cm-variable">actuals</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">dcg_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">relevance</span> <span class="cm-operator">=</span> <span class="cm-variable">np</span>.<span class="cm-property">array</span>([[<span class="cm-builtin">float</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">actuals</span>) <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">score</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span> <span class="cm-operator">-</span> <span class="cm-variable">np</span>.<span class="cm-property">arange</span>(<span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">dcg_score</span>(<span class="cm-variable">relevance</span>, <span class="cm-variable">score</span>.<span class="cm-property">reshape</span>(<span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>), <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">ndcg_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">relevance</span> <span class="cm-operator">=</span> <span class="cm-variable">np</span>.<span class="cm-property">array</span>([[<span class="cm-builtin">float</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">actuals</span>) <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">recs</span>[<span class="cm-number">0</span>:<span class="cm-variable">k</span>]]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">score</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span> <span class="cm-operator">-</span> <span class="cm-variable">np</span>.<span class="cm-property">arange</span>(<span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">ndcg_score</span>(<span class="cm-variable">relevance</span>, <span class="cm-variable">score</span>.<span class="cm-property">reshape</span>(<span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>), <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">recall_stage</span>(<span class="cm-variable">model</span>, <span class="cm-variable">user_id</span>, <span class="cm-variable">user_item_data</span>, <span class="cm-variable">ratings_train</span>, <span class="cm-variable">N</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">filter_items</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[<span class="cm-variable">ratings_train</span>[<span class="cm-string">'user id'</span>] <span class="cm-operator">==</span> <span class="cm-variable">user_id</span>][<span class="cm-string">'item id'</span>].<span class="cm-property">values</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">filter_items</span> <span class="cm-operator">=</span> <span class="cm-variable">filter_items</span> <span class="cm-operator">-</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">user_id</span> <span class="cm-operator">=</span> <span class="cm-variable">user_id</span> <span class="cm-operator">-</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recs</span>, <span class="cm-variable">scores</span> <span class="cm-operator">=</span> <span class="cm-variable">model</span>.<span class="cm-property">recommend</span>(<span class="cm-variable">user_id</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">user_item_data</span>[<span class="cm-variable">user_id</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">filter_items</span><span class="cm-operator">=</span><span class="cm-variable">filter_items</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">N</span><span class="cm-operator">=</span><span class="cm-variable">N_recall</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recs</span> <span class="cm-operator">=</span> <span class="cm-variable">recs</span>.<span class="cm-property">flatten</span>() <span class="cm-operator">+</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">recs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">evaluate</span>(<span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_test_pos</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">actuals</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_test_pos</span>[<span class="cm-variable">ratings_test_pos</span>[<span class="cm-string">'user id'</span>] <span class="cm-operator">==</span> <span class="cm-variable">user_id</span>][<span class="cm-string">'item id'</span>].<span class="cm-property">values</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">precision_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>), <span class="cm-variable">recall_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>), <span class="cm-variable">dcg_k</span>(<span class="cm-variable">actuals</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 801px;"></div><div class="CodeMirror-gutters" style="display: none; height: 801px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># recommend items for a user</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">N_recall</span> <span class="cm-operator">=</span> <span class="cm-number">30</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">user_id</span> <span class="cm-operator">=</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">recs</span> <span class="cm-operator">=</span> <span class="cm-variable">recall_stage</span>(<span class="cm-variable">model</span>, <span class="cm-variable">user_id</span>, <span class="cm-variable">user_item_data</span>, <span class="cm-variable">ratings_train</span>, <span class="cm-variable">N_recall</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">evaluate</span>(<span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_test_pos</span>, <span class="cm-variable">recs</span>, <span class="cm-number">20</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 100px;"></div><div class="CodeMirror-gutters" style="display: none; height: 100px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(0.25, 0.2, 2.0491745551794502)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><p>&nbsp;</p><h2 id='ranking-gpt'><span>Ranking (GPT)</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># !pip install langchain openai == 0.27.0</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><h2 id='gpt-based-排序方法过程'><span>GPT Based 排序方法过程</span></h2><p><span>在该项目中，</span><strong><span>GPT</span></strong><span> 或类似的语言模型用于 </span><strong><span>重新排序</span></strong><span>（re-ranking）推荐结果的过程通常如下：</span></p><h3 id='1-召回阶段recall-stage'><strong><span>1. 召回阶段（Recall Stage）</span></strong></h3><p><span>在召回阶段，通过基于协同过滤、矩阵分解、或者其他推荐算法（如 ALS、KNN 等）为用户生成一个初步的推荐列表。例如，假设你从推荐系统中召回了 </span><strong><span>30</span></strong><span> 个电影。</span></p><h3 id='2-准备用户历史数据'><strong><span>2. 准备用户历史数据</span></strong></h3><ul><li><p><span>在重新排序之前，需要将用户的历史评分数据（如喜欢和不喜欢的电影）传递给语言模型，以便生成个性化的推荐排序。这些数据将作为模型的输入，帮助模型理解用户的偏好。</span></p></li><li><p><span>具体来说，用户的喜好会被转化为 </span><strong><span>&quot;用户喜欢的电影&quot;</span></strong><span> 和 </span><strong><span>&quot;用户不喜欢的电影&quot;</span></strong><span> 的列表，作为模型的输入。</span></p></li></ul><h3 id='3-gpt-进行重新排序'><strong><span>3. GPT 进行重新排序</span></strong></h3><ul><li><p><strong><span>输入</span></strong><span>：用户喜欢和不喜欢的电影列表，以及候选电影（即召回的初步推荐列表）。例如：</span></p><ul><li><p><span>喜欢的电影：</span><code>[The Terminator, Aliens, Matrix]</code></p></li><li><p><span>不喜欢的电影：</span><code>[Fast &amp; Furious, Die Hard]</code></p></li><li><p><span>候选电影列表：</span><code>[Alien, Chinatown, Speed, True Lies, The Piano]</code></p></li></ul><p><span>这些信息将传递给 GPT（或其他语言模型），模型的任务是判断每个候选电影对该用户的适配程度。</span></p></li><li><p><strong><span>输出</span></strong><span>：模型会返回每个候选电影是否符合用户的喜好，并为每个电影提供一个解释。例如：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"title"</span>: <span class="cm-string">"Alien (1979)"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"like"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"explanation"</span>: <span class="cm-string">"The person likes sci-fi and horror films like 'Aliens (1986)' and 'The Terminator (1984)', and 'Alien' is a classic in the same genre."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"title"</span>: <span class="cm-string">"Chinatown (1974)"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"like"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"explanation"</span>: <span class="cm-string">"The person enjoys classic films like 'The Godfather (1972)' and 'Citizen Kane (1941)', and 'Chinatown' is a critically acclaimed noir film that fits their taste."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"title"</span>: <span class="cm-string">"Speed (1994)"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"like"</span>: <span class="cm-atom">false</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"explanation"</span>: <span class="cm-string">"The person dislikes action films like 'Under Siege (1992)' and 'The Rock (1996)', and 'Speed' is a high-octane action film that may not appeal to them."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 440px;"></div><div class="CodeMirror-gutters" style="display: none; height: 440px;"></div></div></div></pre><p><span>在这个例子中，GPT 会对每个候选电影生成是否喜欢（</span><code>like: true/false</code><span>）的标签，并且提供一个解释，阐述为什么它认为这个电影符合或不符合用户的喜好。</span></p></li></ul><h3 id='4-根据模型输出重新排序'><strong><span>4. 根据模型输出重新排序</span></strong></h3><ul><li><p><strong><span>排序</span></strong><span>：根据 GPT 的输出，对候选电影进行排序。模型的输出提供了每个电影是否符合用户偏好的概率（如 </span><code>like: true</code><span> 或 </span><code>false</code><span>），你可以按 </span><strong><span>喜欢的概率</span></strong><span> 对电影进行排序。</span></p></li><li><p><strong><span>最终排序</span></strong><span>：重新排序后的推荐列表将包含电影，按用户最可能喜欢的顺序排列，优先显示更符合用户口味的电影。</span></p></li></ul><h3 id='5-输出'><strong><span>5. 输出</span></strong></h3><ul><li><p><span>返回经过 GPT 排序后的推荐列表，这个列表中的电影按符合用户偏好的程度排列。例如，模型可能会把 </span><code>&quot;Alien (1979)&quot;</code><span> 排在推荐列表的最前面，因为它符合用户的偏好，而将 </span><code>&quot;Speed (1994)&quot;</code><span> 排在后面，因为用户不喜欢动作片。</span></p></li></ul><h3 id='总结-2'><strong><span>总结</span></strong></h3><p><span>GPT 通过以下步骤进行重新排序：</span></p><ol start='' ><li><p><span>接收用户的历史数据（喜欢和不喜欢的电影）以及初步召回的候选电影。</span></p></li><li><p><span>使用语言模型判断每个候选电影是否符合用户的偏好，并给出解释。</span></p></li><li><p><span>根据模型输出的 </span><strong><span>喜欢/不喜欢</span></strong><span> 标志和解释，为推荐列表中的电影重新排序，确保最符合用户兴趣的电影排在最前面。</span></p></li></ol><p><span>这个过程使得推荐结果更加个性化和精准，通过语言模型的强大理解能力，优化了推荐系统的排序质量。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">chat_models</span> <span class="cm-keyword">import</span> <span class="cm-variable">ChatOpenAI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">prompts</span> <span class="cm-keyword">import</span> <span class="cm-variable">ChatPromptTemplate</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">langchain</span>.<span class="cm-property">chains</span> <span class="cm-keyword">import</span> <span class="cm-variable">LLMChain</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置 DeepSeek API 密钥和地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">os</span>.<span class="cm-property">environ</span>[<span class="cm-string">"OPENAI_API_KEY"</span>] <span class="cm-operator">=</span> <span class="cm-string">"*******"</span> &nbsp;<span class="cm-comment"># ✅ 请替换为你的真实密钥</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">os</span>.<span class="cm-property">environ</span>[<span class="cm-string">"OPENAI_API_BASE"</span>] <span class="cm-operator">=</span> <span class="cm-string">"https://api.deepseek.com"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化 DeepSeek LLM 模型（兼容 OpenAI 格式）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">llm</span> <span class="cm-operator">=</span> <span class="cm-variable">ChatOpenAI</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">model_name</span><span class="cm-operator">=</span><span class="cm-string">"deepseek-chat"</span>, &nbsp;<span class="cm-comment"># 模型名（也可为 deepseek-coder 等）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">openai_api_base</span><span class="cm-operator">=</span><span class="cm-variable">os</span>.<span class="cm-property">environ</span>[<span class="cm-string">"OPENAI_API_BASE"</span>], &nbsp;<span class="cm-comment"># API地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">openai_api_key</span><span class="cm-operator">=</span><span class="cm-variable">os</span>.<span class="cm-property">environ</span>[<span class="cm-string">"OPENAI_API_KEY"</span>], &nbsp;<span class="cm-comment"># 密钥</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">temperature</span><span class="cm-operator">=</span><span class="cm-number">0.0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 构建 Prompt 模板</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">prompt</span> <span class="cm-operator">=</span> <span class="cm-variable">ChatPromptTemplate</span>.<span class="cm-property">from_template</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""The person has a list of liked movies: {movies_liked}. \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">The person has a list of disliked movies: {movies_disliked}. \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">Tell me if this person likes each of the candidate movies: {movies_candidates}. \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">Return a list of boolean values and explain why the person likes or dislikes.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&lt;&lt; FORMATTING &gt;&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">Return a markdown code snippet with a list of JSON object formatted to look like:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">{{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  "title": string \\ the name of the movie in candidate movies</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  "like": boolean \\ true or false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  "explanation": string \\ explain why the person likes or dislikes the candidate movie</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">REMEMBER: Each boolean and explanation for each element in candidate movies.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">REMEMBER: The explanation must relate to the person's liked and disliked movies.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 构建 LLM Chain</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">chain</span> <span class="cm-operator">=</span> <span class="cm-variable">LLMChain</span>(<span class="cm-variable">llm</span><span class="cm-operator">=</span><span class="cm-variable">llm</span>, <span class="cm-variable">prompt</span><span class="cm-operator">=</span><span class="cm-variable">prompt</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 801px;"></div><div class="CodeMirror-gutters" style="display: none; height: 801px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">ranking_stage</span>(<span class="cm-variable">chain</span>, <span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_train</span>, <span class="cm-variable">pre_recs</span>, <span class="cm-variable">movie</span>, <span class="cm-variable">batch_size</span><span class="cm-operator">=</span><span class="cm-number">10</span>):</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">few_shot</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[(<span class="cm-variable">ratings_train</span>[<span class="cm-string">'user id'</span>] <span class="cm-operator">==</span> <span class="cm-variable">user_id</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-builtin">len</span>(<span class="cm-variable">few_shot</span>) <span class="cm-operator">&gt;=</span> <span class="cm-number">300</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">few_shot</span> <span class="cm-operator">=</span> <span class="cm-variable">few_shot</span>.<span class="cm-property">sample</span>(<span class="cm-number">300</span>, <span class="cm-variable">random_state</span><span class="cm-operator">=</span><span class="cm-number">42</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recall_recs</span> <span class="cm-operator">=</span> <span class="cm-variable">movie</span>.<span class="cm-property">set_index</span>(<span class="cm-string">'item id'</span>).<span class="cm-property">loc</span>[<span class="cm-variable">pre_recs</span>].<span class="cm-property">reset_index</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">movies_liked</span> <span class="cm-operator">=</span> <span class="cm-string">','</span>.<span class="cm-property">join</span>(<span class="cm-variable">few_shot</span>[<span class="cm-variable">few_shot</span>[<span class="cm-string">'like'</span>]][<span class="cm-string">'title'</span>].<span class="cm-property">values</span>.<span class="cm-property">tolist</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">movies_disliked</span> <span class="cm-operator">=</span> <span class="cm-string">','</span>.<span class="cm-property">join</span>(<span class="cm-variable">few_shot</span>[<span class="cm-operator">~</span><span class="cm-variable">few_shot</span>[<span class="cm-string">'like'</span>]][<span class="cm-string">'title'</span>].<span class="cm-property">values</span>.<span class="cm-property">tolist</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">n_batch</span> <span class="cm-operator">=</span> <span class="cm-builtin">int</span>(<span class="cm-variable">np</span>.<span class="cm-property">ceil</span>(<span class="cm-builtin">len</span>(<span class="cm-variable">recall_recs</span>) <span class="cm-operator">/</span> <span class="cm-variable">batch_size</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">candidates</span> <span class="cm-operator">=</span> <span class="cm-variable">recall_recs</span>[[<span class="cm-string">'item id'</span>, <span class="cm-string">'title'</span>]]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_json</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-variable">n_batch</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">candidates_batch</span> <span class="cm-operator">=</span> <span class="cm-variable">candidates</span>.<span class="cm-property">iloc</span>[<span class="cm-variable">i</span> <span class="cm-operator">*</span> <span class="cm-variable">batch_size</span>: (<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-variable">batch_size</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">movies_candidates</span> <span class="cm-operator">=</span> <span class="cm-string">','</span>.<span class="cm-property">join</span>(<span class="cm-variable">candidates_batch</span>[<span class="cm-string">'title'</span>].<span class="cm-property">values</span>.<span class="cm-property">tolist</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result</span> <span class="cm-operator">=</span> <span class="cm-variable">chain</span>.<span class="cm-property">run</span>(<span class="cm-variable">movies_liked</span><span class="cm-operator">=</span><span class="cm-variable">movies_liked</span>, <span class="cm-variable">movies_disliked</span><span class="cm-operator">=</span><span class="cm-variable">movies_disliked</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">movies_candidates</span><span class="cm-operator">=</span><span class="cm-variable">movies_candidates</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result_list</span> <span class="cm-operator">=</span> <span class="cm-variable">result</span>.<span class="cm-property">replace</span>(<span class="cm-string">'\n'</span>, <span class="cm-string">''</span>).<span class="cm-property">replace</span>(<span class="cm-string">'},'</span>, <span class="cm-string">'}\n,'</span>).<span class="cm-property">split</span>(<span class="cm-string">'\n,'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result_json_batch</span> <span class="cm-operator">=</span> [<span class="cm-variable">json</span>.<span class="cm-property">loads</span>(<span class="cm-variable">i</span>) <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">result_list</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result_json</span> <span class="cm-operator">=</span> <span class="cm-variable">result_json</span> <span class="cm-operator">+</span> <span class="cm-variable">result_json_batch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_rank</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>.<span class="cm-property">from_dict</span>(<span class="cm-variable">result_json</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_rank</span>[<span class="cm-string">'item id'</span>] <span class="cm-operator">=</span> <span class="cm-variable">recall_recs</span>[<span class="cm-string">'item id'</span>].<span class="cm-property">values</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_rank</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">concat</span>([<span class="cm-variable">result_rank</span>[<span class="cm-variable">result_rank</span>[<span class="cm-string">'like'</span>]], <span class="cm-variable">result_rank</span>[<span class="cm-operator">~</span><span class="cm-variable">result_rank</span>[<span class="cm-string">'like'</span>]]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">result_rank</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 560px;"></div><div class="CodeMirror-gutters" style="display: none; height: 560px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">numpy</span> <span class="cm-keyword">as</span> <span class="cm-variable">np</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pandas</span> <span class="cm-keyword">as</span> <span class="cm-variable">pd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">debug_ranking_stage_raw_output</span>(<span class="cm-variable">chain</span>, <span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_train</span>, <span class="cm-variable">pre_recs</span>, <span class="cm-variable">movie</span>, <span class="cm-variable">batch_size</span><span class="cm-operator">=</span><span class="cm-number">10</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">few_shot</span> <span class="cm-operator">=</span> <span class="cm-variable">ratings_train</span>[<span class="cm-variable">ratings_train</span>[<span class="cm-string">'user id'</span>] <span class="cm-operator">==</span> <span class="cm-variable">user_id</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-builtin">len</span>(<span class="cm-variable">few_shot</span>) <span class="cm-operator">&gt;=</span> <span class="cm-number">300</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">few_shot</span> <span class="cm-operator">=</span> <span class="cm-variable">few_shot</span>.<span class="cm-property">sample</span>(<span class="cm-number">300</span>, <span class="cm-variable">random_state</span><span class="cm-operator">=</span><span class="cm-number">42</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">recall_recs</span> <span class="cm-operator">=</span> <span class="cm-variable">movie</span>.<span class="cm-property">set_index</span>(<span class="cm-string">'item id'</span>).<span class="cm-property">loc</span>[<span class="cm-variable">pre_recs</span>].<span class="cm-property">reset_index</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">movies_liked</span> <span class="cm-operator">=</span> <span class="cm-string">','</span>.<span class="cm-property">join</span>(<span class="cm-variable">few_shot</span>[<span class="cm-variable">few_shot</span>[<span class="cm-string">'like'</span>]][<span class="cm-string">'title'</span>].<span class="cm-property">values</span>.<span class="cm-property">tolist</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">movies_disliked</span> <span class="cm-operator">=</span> <span class="cm-string">','</span>.<span class="cm-property">join</span>(<span class="cm-variable">few_shot</span>[<span class="cm-operator">~</span><span class="cm-variable">few_shot</span>[<span class="cm-string">'like'</span>]][<span class="cm-string">'title'</span>].<span class="cm-property">values</span>.<span class="cm-property">tolist</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">n_batch</span> <span class="cm-operator">=</span> <span class="cm-builtin">int</span>(<span class="cm-variable">np</span>.<span class="cm-property">ceil</span>(<span class="cm-builtin">len</span>(<span class="cm-variable">recall_recs</span>) <span class="cm-operator">/</span> <span class="cm-variable">batch_size</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">candidates</span> <span class="cm-operator">=</span> <span class="cm-variable">recall_recs</span>[[<span class="cm-string">'item id'</span>, <span class="cm-string">'title'</span>]]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">raw_outputs</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-variable">n_batch</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">candidates_batch</span> <span class="cm-operator">=</span> <span class="cm-variable">candidates</span>.<span class="cm-property">iloc</span>[<span class="cm-variable">i</span> <span class="cm-operator">*</span> <span class="cm-variable">batch_size</span>: (<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-variable">batch_size</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">movies_candidates</span> <span class="cm-operator">=</span> <span class="cm-string">','</span>.<span class="cm-property">join</span>(<span class="cm-variable">candidates_batch</span>[<span class="cm-string">'title'</span>].<span class="cm-property">values</span>.<span class="cm-property">tolist</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"\n--- Batch </span>{<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>}<span class="cm-string">/</span>{<span class="cm-variable">n_batch</span>}<span class="cm-string"> ---"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"[Candidates]: </span>{<span class="cm-variable">movies_candidates</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result</span> <span class="cm-operator">=</span> <span class="cm-variable">chain</span>.<span class="cm-property">run</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">movies_liked</span><span class="cm-operator">=</span><span class="cm-variable">movies_liked</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">movies_disliked</span><span class="cm-operator">=</span><span class="cm-variable">movies_disliked</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">movies_candidates</span><span class="cm-operator">=</span><span class="cm-variable">movies_candidates</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># print(f"[Raw LLM Output]:\n{result}\n")</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">raw_outputs</span>.<span class="cm-property">append</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'batch_index'</span>: <span class="cm-variable">i</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'candidates'</span>: <span class="cm-variable">candidates_batch</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'raw_text'</span>: <span class="cm-variable">result</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">raw_outputs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">re</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">extract_json_array</span>(<span class="cm-variable">text</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 匹配 JSON 列表内容（中间可能换行）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">match</span> <span class="cm-operator">=</span> <span class="cm-variable">re</span>.<span class="cm-property">search</span>(<span class="cm-string">r"\[\s*\{.*?\}\s*\]"</span>, <span class="cm-variable">text</span>, <span class="cm-variable">re</span>.<span class="cm-property">DOTALL</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">match</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">json</span>.<span class="cm-property">loads</span>(<span class="cm-variable">match</span>.<span class="cm-property">group</span>(<span class="cm-number">0</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">json</span>.<span class="cm-property">JSONDecodeError</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"[解析失败] JSONDecodeError: </span>{<span class="cm-variable">e</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">else</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">"[警告] 没有找到 JSON 列表"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">parse_rank_result_from_raw_outputs</span>(<span class="cm-variable">raw_outputs</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_json_all</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">batch</span> <span class="cm-keyword">in</span> <span class="cm-variable">raw_outputs</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">raw_text</span> <span class="cm-operator">=</span> <span class="cm-variable">batch</span>[<span class="cm-string">'raw_text'</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">candidates_df</span> <span class="cm-operator">=</span> <span class="cm-variable">batch</span>[<span class="cm-string">'candidates'</span>].<span class="cm-property">reset_index</span>(<span class="cm-variable">drop</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 提取 JSON 数组字符串并解析</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json_array</span> <span class="cm-operator">=</span> <span class="cm-variable">extract_json_array</span>(<span class="cm-variable">raw_text</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"[ERROR] 解析失败: </span>{<span class="cm-variable">e</span>}<span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json_array</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 加上原来的 item id（标题顺序匹配即可）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">idx</span>, <span class="cm-variable">item</span> <span class="cm-keyword">in</span> <span class="cm-builtin">enumerate</span>(<span class="cm-variable">json_array</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">item</span>[<span class="cm-string">'item id'</span>] <span class="cm-operator">=</span> <span class="cm-variable">candidates_df</span>.<span class="cm-property">loc</span>[<span class="cm-variable">idx</span>, <span class="cm-string">'item id'</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result_json_all</span>.<span class="cm-property">extend</span>(<span class="cm-variable">json_array</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 转为 DataFrame，并按 'like' 优先排序</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_rank</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(<span class="cm-variable">result_json_all</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">result_rank</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">concat</span>([</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result_rank</span>[<span class="cm-variable">result_rank</span>[<span class="cm-string">'like'</span>]],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result_rank</span>[<span class="cm-operator">~</span><span class="cm-variable">result_rank</span>[<span class="cm-string">'like'</span>]]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">result_rank</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1761px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1761px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">raw_outputs</span> <span class="cm-operator">=</span> <span class="cm-variable">debug_ranking_stage_raw_output</span>(<span class="cm-variable">chain</span>, <span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_train</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">movie</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00391px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">D:\mambaforge\envs\ml\lib\site-packages\langchain_core\_api\deprecation.py:117: LangChainDeprecationWarning: The function `run` was deprecated in LangChain 0.1.0 and will be removed in 0.2.0. Use invoke instead.</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  warn_deprecated(</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 80px;"></div><div class="CodeMirror-gutters" style="display: none; height: 80px;"></div></div></div></pre><p><span>    </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">--- Batch 1/3 ---</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[Candidates]: Alien (1979),Chinatown (1974),Close Shave, A (1995),Birds, The (1963),City of Lost Children, The (1995),Speed (1994),Dead Poets Society (1989),True Lies (1994),Piano, The (1993),Leaving Las Vegas (1995)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[Raw LLM Output]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">```json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Alien (1979)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes sci-fi and horror movies like 'Aliens (1986)' and 'The Terminator (1984)', which are in the same genre and directed by James Cameron, who also directed 'Aliens'. Additionally, the person enjoys Ridley Scott's 'Blade Runner (1982)', suggesting an appreciation for his work."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Chinatown (1974)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys classic films like 'The Godfather (1972)' and 'Citizen Kane (1941)', and 'Chinatown' is a critically acclaimed neo-noir film that fits their taste for well-regarded cinema. They also like 'The Sting (1973)', another classic from the same era."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Close Shave, A (1995)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes animated and quirky films like 'Wallace &amp; Gromit: The Best of Aardman Animation (1996)' and 'Toy Story (1995)'. 'A Close Shave' is part of the Wallace &amp; Gromit series, which aligns with their preferences for clever and humorous animation."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Birds, The (1963)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys classic horror/thriller films like 'Psycho (1960)' and 'The Shining (1980)', and 'The Birds' is another Hitchcock masterpiece in the same vein. Their dislike of 'A Nightmare on Elm Street (1984)' doesn't extend to more psychological horror, which they seem to appreciate."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "City of Lost Children, The (1995)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes visually distinctive and unconventional films like 'Delicatessen (1991)' and 'The Haunted World of Edward D. Wood Jr. (1995)'. 'The City of Lost Children' shares a similar surreal and artistic style, making it likely they would enjoy it."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Speed (1994)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": false,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person dislikes action-heavy, mainstream blockbusters like 'Twister (1996)' and 'The Rock (1996)'. 'Speed' falls into this category, and their preference leans more toward critically acclaimed or unique films rather than pure action thrillers."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Dead Poets Society (1989)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys dramatic and emotionally resonant films like 'The Shawshank Redemption (1994)' and 'Good Will Hunting (1997)'. 'Dead Poets Society' fits this mold with its inspirational and heartfelt storytelling."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "True Lies (1994)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": false,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person dislikes over-the-top action films like 'Die Hard 2 (1990)' and 'The Long Kiss Goodnight (1996)'. 'True Lies' is a high-energy action-comedy that doesn't align with their preference for more subdued or critically praised films."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Piano, The (1993)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person appreciates artistic and emotionally complex films like 'The Unbearable Lightness of Being (1988)' and 'Remains of the Day (1993)'. 'The Piano' is a critically acclaimed drama that fits their taste for nuanced storytelling."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Leaving Las Vegas (1995)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes intense, character-driven dramas like 'Dead Man Walking (1995)' and 'Taxi Driver (1976)'. 'Leaving Las Vegas' is a gritty, emotional film that aligns with their appreciation for raw and powerful performances."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">```</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1701px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1701px;"></div></div></div></pre><p><span>    </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">--- Batch 2/3 ---</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[Candidates]: That Thing You Do! (1996),Bob Roberts (1992),Hamlet (1996),Schindler's List (1993),Muriel's Wedding (1994),GoodFellas (1990),Star Trek: First Contact (1996),Strictly Ballroom (1992),Cinema Paradiso (1988),Adventures of Priscilla, Queen of the Desert, The (1994)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[Raw LLM Output]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">```json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "That Thing You Do! (1996)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys lighthearted and comedic films like 'Austin Powers: International Man of Mystery (1997)' and 'While You Were Sleeping (1995)', and 'That Thing You Do!' fits this tone. It's also a music-themed film, and the person liked 'The Blues Brothers (1980)', which suggests an appreciation for music-driven narratives."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Bob Roberts (1992)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes satirical and politically charged films like 'Quiz Show (1994)' and 'The Candidate (1972)', and 'Bob Roberts' is a political satire. Additionally, the person enjoys Tim Robbins' work, as they liked 'The Shawshank Redemption (1994)' and 'The Hudsucker Proxy (1994)'."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Hamlet (1996)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": false,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person dislikes Shakespeare adaptations like 'Much Ado About Nothing (1993)' and 'Richard III (1995)'. While they appreciate dramatic films, 'Hamlet' might be too heavy or traditional for their taste, given their preference for more modern or unconventional storytelling."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Schindler's List (1993)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person appreciates intense, well-crafted dramas like 'The Shawshank Redemption (1994)' and 'Dead Man Walking (1995)'. 'Schindler's List' is a critically acclaimed historical drama, which aligns with their liking for serious, impactful films."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Muriel's Wedding (1994)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys quirky, character-driven comedies like 'The Full Monty (1997)' and 'Strictly Ballroom (1992)'. 'Muriel's Wedding' is a similarly offbeat and heartfelt comedy, which fits their taste."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "GoodFellas (1990)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes crime dramas and films with strong direction, such as 'The Godfather (1972)' and 'Pulp Fiction (1994)'. 'GoodFellas' is a classic crime film that aligns with their appreciation for gritty, well-made narratives."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Star Trek: First Contact (1996)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person is a fan of the 'Star Trek' franchise, having liked 'Star Trek IV: The Voyage Home (1986)' and 'Star Trek VI: The Undiscovered Country (1991)'. 'First Contact' is a well-regarded entry in the series, so it's likely they would enjoy it."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Strictly Ballroom (1992)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys quirky, feel-good films like 'The Full Monty (1997)' and 'Muriel's Wedding (1994)'. 'Strictly Ballroom' is a charming, offbeat comedy with a romantic edge, which fits their preferences."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Cinema Paradiso (1988)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person appreciates heartfelt, nostalgic films like 'The Princess Bride (1987)' and 'Jean de Florette (1986)'. 'Cinema Paradiso' is a touching, sentimental film about love for cinema, which aligns with their taste."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Adventures of Priscilla, Queen of the Desert, The (1994)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys unconventional and visually striking films like 'Delicatessen (1991)' and 'The Nightmare Before Christmas (1993)'. 'Priscilla' is a vibrant, eccentric road movie, which fits their appreciation for unique storytelling."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">```</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1701px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1701px;"></div></div></div></pre><p><span>    </span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">--- Batch 3/3 ---</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[Candidates]: Star Trek: Generations (1994),In the Line of Fire (1993),Rosencrantz and Guildenstern Are Dead (1990),Brazil (1985),Heathers (1989),When We Were Kings (1996),One Flew Over the Cuckoo's Nest (1975),Mighty Aphrodite (1995),Cool Hand Luke (1967),Shallow Grave (1994)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[Raw LLM Output]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">```json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Star Trek: Generations (1994)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes several Star Trek movies (e.g., Star Trek IV, Star Trek VI) and sci-fi films (e.g., Contact, Blade Runner), so they are likely to enjoy this entry in the franchise."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "In the Line of Fire (1993)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys thrillers and action films (e.g., Die Hard, The Fugitive), and this movie fits that genre well. They also like Clint Eastwood films (e.g., Unforgiven)."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Rosencrantz and Guildenstern Are Dead (1990)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": false,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person dislikes some Shakespeare adaptations (e.g., Much Ado About Nothing) and this film's abstract, theatrical style may not align with their preferences for more straightforward narratives."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Brazil (1985)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys dark, satirical, and visually distinctive films (e.g., Delicatessen, Monty Python movies), and Brazil fits this style. They also like Terry Gilliam's work (e.g., 12 Monkeys)."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Heathers (1989)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes dark comedies and unconventional films (e.g., Pulp Fiction, Fargo), and Heathers aligns with this taste. They also enjoy 1980s movies with unique tones."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "When We Were Kings (1996)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person appreciates documentaries (e.g., Hoop Dreams, Crumb) and this acclaimed documentary about Muhammad Ali would likely appeal to them."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "One Flew Over the Cuckoo's Nest (1975)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes classic, critically acclaimed dramas (e.g., The Godfather, 12 Angry Men), and this film fits that category. They also enjoy Jack Nicholson's work (e.g., The Shining is disliked, but they like other Nicholson films)."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Mighty Aphrodite (1995)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": false,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person dislikes some Woody Allen films (e.g., not listed in liked movies) and may not connect with this lighter, romantic comedy style compared to their preference for darker or more intense films."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Cool Hand Luke (1967)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person enjoys classic films (e.g., The Graduate, Citizen Kane) and Paul Newman's work (e.g., The Sting is liked). This film's rebellious tone and strong performances align with their tastes."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "title": "Shallow Grave (1994)",</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "like": true,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  "explanation": "The person likes dark, suspenseful films (e.g., Reservoir Dogs, Pulp Fiction) and this early Danny Boyle film fits that style. They also enjoy crime thrillers with twists."</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">```</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1581px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1581px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rank_result</span> <span class="cm-operator">=</span> <span class="cm-variable">parse_rank_result_from_raw_outputs</span>(<span class="cm-variable">raw_outputs</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rank_recs</span> <span class="cm-operator">=</span> <span class="cm-variable">rank_result</span>[<span class="cm-string">'item id'</span>].<span class="cm-property">values</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># rank_recs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p</span>, <span class="cm-variable">r</span>, <span class="cm-variable">ndcg</span> <span class="cm-operator">=</span> <span class="cm-variable">evaluate</span>(<span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_test_pos</span>, <span class="cm-variable">rank_recs</span>, <span class="cm-variable">k</span><span class="cm-operator">=</span><span class="cm-number">5</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 80px;"></div><div class="CodeMirror-gutters" style="display: none; height: 80px;"></div></div></div></pre><h2 id='输出结果解读'><span>输出结果解读：</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">((<span class="cm-number">0.25</span>, <span class="cm-number">0.2</span>, <span class="cm-number">2.049</span>), &nbsp;<span class="cm-comment"># 初步召回结果</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> (<span class="cm-number">0.30</span>, <span class="cm-number">0.24</span>, <span class="cm-number">2.370</span>)) <span class="cm-comment"># rerank 后结果</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 40px;"></div><div class="CodeMirror-gutters" style="display: none; height: 40px;"></div></div></div></pre><figure class='table-figure'><table><thead><tr><th><span>指标</span></th><th><span>协同过滤</span></th><th><span>GPT Based 方法</span></th><th><span>变化</span></th></tr></thead><tbody><tr><td><strong><span>P@20</span></strong></td><td><span>0.25</span></td><td><span>0.30</span></td><td><span>提升</span></td></tr><tr><td><strong><span>R@20</span></strong></td><td><span>0.20</span></td><td><span>0.24</span></td><td><span>提升</span></td></tr><tr><td><strong><span>NDCG@20</span></strong></td><td><span>2.049</span></td><td><span>2.370</span></td><td><span>提升</span></td></tr></tbody></table></figure><hr /><h2 id='结论'><span>结论：</span></h2><ul><li><p><strong><span>准确率</span></strong><span> 提升 +20%（0.25 → 0.30）</span></p></li><li><p><strong><span>召回率</span></strong><span> 提升 +20%（0.20 → 0.24）</span></p></li><li><p><strong><span>NDCG</span></strong><span> 提升，推荐更准确</span></p></li></ul><p><span>LLM reranking 提升了推荐质量，正确推荐的电影更多且排序更靠前。</span></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">20</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">evaluate</span>(<span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_test_pos</span>, <span class="cm-variable">recs</span>, <span class="cm-variable">k</span>), <span class="cm-variable">evaluate</span>(<span class="cm-variable">user_id</span>, <span class="cm-variable">ratings_test_pos</span>, <span class="cm-variable">rank_recs</span>, <span class="cm-variable">k</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 60px;"></div><div class="CodeMirror-gutters" style="display: none; height: 60px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">((0.25, 0.2, 2.0491745551794502), (0.3, 0.24, 2.34713553777021))</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">!</span><span class="cm-variable">jupyter</span> <span class="cm-variable">nbconvert</span> <span class="cm-operator">--</span><span class="cm-variable">to</span> <span class="cm-variable">markdown</span> <span class="cm-variable">llm_recs_2</span>.<span class="cm-property">ipynb</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.00781px; left: 12px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[NbConvertApp] Converting notebook llm_recs_2.ipynb to markdown</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[NbConvertApp] Writing 34187 bytes to llm_recs_2.md</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 40px;"></div><div class="CodeMirror-gutters" style="display: none; height: 40px;"></div></div></div></pre><p>&nbsp;</p></div></div>
</body>
</html>